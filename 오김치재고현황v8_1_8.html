<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>김치 재고 관리 — v8.1.8 (합계 행 추가)</title>
<style>
:root{--bg:#f7f7f9;--card:#ffffff;--accent:#c33;--muted:#666}
*{box-sizing:border-box;font-family:Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, Arial}
body{margin:0;padding:18px;background:linear-gradient(180deg,#fbfbfb,#eef4f8);color:#111}
.container{max-width:1200px;margin:0 auto}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
h1{font-size:20px;margin:0}
.layout{display:grid;grid-template-columns:360px 1fr;gap:14px}
.panel{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
.search{display:flex;gap:8px;margin-bottom:8px}
.item-list{min-height:200px;max-height:72vh;overflow:auto;border:1px solid #f1f3f6;border-radius:8px;padding:8px;background:#fff}
.item-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
.item-row:hover{background:#fafafa}
.item-row.selected{background:#fff2f2;border:1px solid rgba(200,50,50,0.08)}
.badge{background:#fff6f6;color:var(--accent);padding:4px 8px;border-radius:12px;border:1px solid #f2d8d8;font-weight:600}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.input{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
.input.small{padding:6px;font-size:13px}
.btn{cursor:pointer;border:none;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px}
.btn.ghost{background:transparent;border:1px solid #ddd;color:#333}
.btn.tiny{padding:4px 8px;font-size:12px}
.small{font-size:13px;color:#666}
.detail-area{margin-top:10px;border-top:1px dashed #f1f3f6;padding-top:10px}
.detail-table{width:100%;border-collapse:collapse;margin-top:6px}
.detail-table th,.detail-table td{padding:6px;border:1px solid #eee;font-size:13px;text-align:left;vertical-align:middle}
.detail-table tfoot td{font-weight:700;background:#fff8f8}
.right-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap}
.hint{font-size:13px;color:#777;margin-top:8px}
.status{background:#fff3cd;border:1px solid #ffe8a1;color:#6b4f00;padding:8px;border-radius:8px;margin-bottom:10px;font-size:13px;display:none}
.banner{background:#fdeaea;border:1px solid #f6c2c2;color:#7a1e1e;padding:10px;border-radius:8px;margin-bottom:10px;font-size:13px}
.inline-editor input{width:100%;}
@media(max-width:880px){.layout{grid-template-columns:1fr}.item-list{max-height:40vh}}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>김치 재고 관리 <span class="small">v8.1.8 (합계 행)</span></h1>
    <div class="small">XLSX/XML 불러오기 · 수동입력 · 인라인 편집 · <b>합계 행</b></div>
  </header>

  <div id="status" class="status"></div>
  <div id="cdnFail" class="banner" style="display:none">⚠️ XLSX 파서(CDN)를 불러오지 못했습니다. XML(2003)로 우회하세요.</div>

  <div class="layout">
    <!-- LEFT -->
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>품목 목록</strong>
        <div class="small">총 <span id="totalCount">0</span>개</div>
      </div>

      <div class="search">
        <input id="search" class="input" placeholder="검색(품목명)" style="flex:1" />
        <button id="addQuickBtn" class="btn ghost" type="button">빠른 추가</button>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;align-items:center">
        <div>
          <div class="small" style="margin-bottom:4px">엑셀 불러오기(XLSX) — <span id="xlsState" class="small">상태 확인중…</span></div>
          <input id="fileXlsx" class="input" type="file" accept=".xlsx,.xlsb,.xlsm" />
        </div>
        <div>
          <div class="small" style="margin-bottom:4px">엑셀 불러오기(XML 2003)</div>
          <input id="fileXml" class="input" type="file" accept=".xml" />
        </div>
        <button id="exportXlsx" class="btn ghost" type="button">엑셀 내보내기</button>
        <button id="exportCsv" class="btn ghost" type="button">CSV 내보내기</button>
        <button id="resetData" class="btn" style="background:#777" type="button">데이터 초기화</button>
        <span id="spinner" class="small" style="display:none">처리중...</span>
      </div>

      <div id="itemList" class="item-list" role="list"></div>

      <div class="detail-area small">
        <div>양식 A(XLSX): 1열 날짜 · 2열 헤더에 <b>품목명: XXX</b> · 옆에 <b>생산/출고/재고</b> · 두 번째 행 초기재고 · 마지막 <b>합계</b> 무시</div>
        <div>양식 B(XML): 넓은 테이블(품목 헤더 아래 생산/출고/재고)도 자동 인식</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="right-top">
        <div style="min-width:220px">
          <div class="small">선택 품목</div>
          <input id="editName" class="input small" placeholder="품목명" />
        </div>
        <div>
          <div class="small">단위</div>
          <input id="editUnit" class="input small" style="width:100px" value="kg" />
        </div>
        <div>
          <div class="small">현재 수량</div>
          <input id="editQty" type="number" class="input small" style="width:120px" value="0" />
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button id="saveItem" class="btn ghost" type="button" title="품목명/단위/수량 저장">품목 저장</button>
          <button id="deleteItem" class="btn" style="background:#ff6666" type="button" title="선택 품목 삭제">품목 삭제</button>
        </div>
      </div>

      <div id="controls">
        <div class="form-row">
          <label class="small" style="width:70px">날짜</label>
          <input id="inputDate" type="date" class="input" style="width:180px" />
          <label class="small" style="width:60px">생산량</label>
          <input id="produceQty" type="number" class="input" style="width:120px" value="0" />
          <label class="small" style="width:60px">출고량</label>
          <input id="outQty" type="number" class="input" style="width:120px" value="0" />
          <label class="small" style="width:60px">비고</label>
          <input id="recNote" class="input" style="flex:1" placeholder="간단 메모" />
          <button id="addRecord" class="btn" type="button">기록 추가</button>
        </div>
      </div>

      <div class="detail-area" id="accordionArea" style="margin-top:12px">
        <strong>일자별 내역 (인라인 편집 가능)</strong>
        <div id="accordionList"></div>
      </div>

      <div class="hint">데이터는 브라우저 로컬에 저장됩니다.</div>
    </div>
  </div>
</div>

<script>
const statusEl = document.getElementById('status');
function setStatus(msg){ statusEl.style.display='block'; statusEl.textContent = msg; console.warn(msg); }
function clearStatus(){ statusEl.style.display='none'; statusEl.textContent=''; }
const spinner = document.getElementById('spinner');
const xlsState = document.getElementById('xlsState');
const cdnFailBanner = document.getElementById('cdnFail');

const STORAGE_KEY = 'kimchi_inventory_v7';
let items = []; let selectedId = null;

// Helpers
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function todayStr(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate()); }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); renderList(); }
function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); items = raw? JSON.parse(raw) : []; }catch(e){ items=[]; } }
function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function sortDetailsByDate(arr){ arr.sort((a,b)=> (a.date||'').localeCompare(b.date||'')); return arr; }
function normalizeItem(it){
  it = it || {};
  it.id = it.id || uid();
  it.name = (it.name||'').trim() || '이름없음';
  it.qty = Number(it.qty)||0;
  it.unit = (it.unit && String(it.unit).trim()) || 'kg';
  it.details = Array.isArray(it.details)?it.details:[];
  it.details.forEach(d=>{ d.date=d.date||''; d.produce=Number(d.produce)||0; d.out=Number(d.out)||0; d.note=d.note||''; });
  sortDetailsByDate(it.details);
  return it;
}
function toNum(v){ if(v==null) return 0; const s=String(v).replace(/,/g,'').trim(); if(!s || s==='-'||s==='–'||s==='—'||s==='.') return 0; const n=Number(s); return Number.isFinite(n)?n:0; }

// UI refs
const itemList = document.getElementById('itemList');
const totalCount = document.getElementById('totalCount');
const search = document.getElementById('search');
const inputDate = document.getElementById('inputDate');
const produceQty = document.getElementById('produceQty');
const outQty = document.getElementById('outQty');
const recNote = document.getElementById('recNote');
const accordionList = document.getElementById('accordionList');
const addQuickBtn = document.getElementById('addQuickBtn');
const saveItemBtn = document.getElementById('saveItem');
const deleteItemBtn = document.getElementById('deleteItem');
const fileXlsx = document.getElementById('fileXlsx');
const fileXml = document.getElementById('fileXml');
const exportXlsx = document.getElementById('exportXlsx');
const exportCsv = document.getElementById('exportCsv');
const resetBtn = document.getElementById('resetData');
const editName = document.getElementById('editName');
const editUnit = document.getElementById('editUnit');
const editQty = document.getElementById('editQty');

function renderList(){
  itemList.innerHTML = '';
  const q = (search.value||'').trim().toLowerCase();
  if(items.length===0){
    const empty = document.createElement('div');
    empty.className='small'; empty.style.padding='16px';
    empty.innerHTML='현재 품목이 없습니다. <b>엑셀 불러오기</b> 또는 <b>빠른 추가</b>를 이용하세요.';
    itemList.appendChild(empty);
  }else{
    items.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(it=>{
      if(q && !(it.name||'').toLowerCase().includes(q)) return;
      const div=document.createElement('div');
      div.className='item-row' + (it.id===selectedId?' selected':'');
      div.dataset.id=it.id;
      div.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong></div>
        <div style="display:flex;gap:8px;align-items:center"><div class="small">수량</div><div class="badge">${escapeHtml(it.qty)}</div></div>`;
      div.addEventListener('click', ()=> selectItem(it.id));
      itemList.appendChild(div);
    });
  }
  totalCount.textContent = items.length;
}

function selectItem(id){
  selectedId = id;
  const it = items.find(x=>x.id===id);
  if(!it){ editName.value=''; editUnit.value='kg'; editQty.value=0; accordionList.innerHTML=''; return; }
  editName.value = it.name; editUnit.value = it.unit || 'kg'; editQty.value = it.qty || 0;
  inputDate.value=todayStr(); produceQty.value=0; outQty.value=0; recNote.value='';
  renderAccordion(it); renderList();
}

// ---- 합계 행 포함 내역 렌더링 ----
function renderAccordion(it){
  accordionList.innerHTML='';
  const details = (it.details||[]).slice().sort((a,b)=> (a.date||'').localeCompare(b.date||''));

  const table=document.createElement('table'); table.className='detail-table';
  table.innerHTML = `<thead>
      <tr><th style="width:120px">날짜</th><th style="width:100px">생산</th><th style="width:100px">출고</th><th>비고</th><th style="width:150px">액션</th></tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr><td><b>합계</b></td><td id="sumProduce"><b>0</b></td><td id="sumOut"><b>0</b></td>
          <td colspan="2" id="sumStock" style="font-weight:700">최종 재고: 0</td></tr>
    </tfoot>`;
  const tb=table.querySelector('tbody');
  let totalP=0, totalO=0;

  details.forEach((d,idx)=>{
    totalP += Number(d.produce)||0; totalO += Number(d.out)||0;
    const tr=document.createElement('tr'); tr.dataset.idx = String(idx);
    tr.innerHTML = `<td>${escapeHtml(d.date||'')}</td>
                    <td>${escapeHtml(d.produce||0)}</td>
                    <td>${escapeHtml(d.out||0)}</td>
                    <td>${escapeHtml(d.note||'')}</td>
                    <td>
                      <button class="btn ghost tiny edit">편집</button>
                      <button class="btn ghost tiny copy">복사</button>
                      <button class="btn tiny del" style="background:#ff6666">삭제</button>
                    </td>`;
    // Edit handler
    tr.querySelector('.edit').addEventListener('click',()=> startInlineEdit(it, idx));
    tr.querySelector('.copy').addEventListener('click',()=>{
      it.details.push({date: d.date, produce: d.produce, out: d.out, note: d.note});
      it.qty = (Number(it.qty)||0) + (Number(d.produce)||0) - (Number(d.out)||0);
      save(); selectItem(it.id);
    });
    tr.querySelector('.del').addEventListener('click',()=>{
      if(!confirm('이 기록을 삭제하시겠습니까?')) return;
      const old = it.details[idx];
      it.qty = (Number(it.qty)||0) - ((Number(old.produce)||0) - (Number(old.out)||0));
      it.details.splice(idx,1); save(); selectItem(it.id);
    });
    tb.appendChild(tr);
  });

  // 합계 반영
  table.querySelector('#sumProduce').innerHTML = `<b>${totalP}</b>`;
  table.querySelector('#sumOut').innerHTML = `<b>${totalO}</b>`;
  table.querySelector('#sumStock').textContent = `최종 재고: ${Number(it.qty)||0}`;

  accordionList.appendChild(table);
}

function startInlineEdit(it, idx){
  const details = (it.details||[]).slice().sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  const d = details[idx];
  const real = it.details.find(x => x.date===d.date && x.produce===d.produce && x.out===d.out && x.note===d.note) || it.details[idx];

  const rows = accordionList.querySelectorAll('tbody tr');
  const tr = rows[idx];
  const old = {date: real.date||'', produce: Number(real.produce)||0, out: Number(real.out)||0, note: real.note||''};

  tr.classList.add('inline-editor');
  tr.innerHTML = `<td><input type="date" class="input small" value="${old.date}"></td>
                  <td><input type="number" class="input small" value="${old.produce}"></td>
                  <td><input type="number" class="input small" value="${old.out}"></td>
                  <td><input type="text" class="input small" value="${old.note.replace(/"/g,'&quot;')}"></td>
                  <td>
                    <button class="btn tiny save">저장</button>
                    <button class="btn ghost tiny cancel">취소</button>
                  </td>`;
  const [iDate, iP, iO, iNote] = tr.querySelectorAll('input');
  const saveBtn = tr.querySelector('.save');
  const cancelBtn = tr.querySelector('.cancel');

  function commit(){
    const newRec = {
      date: iDate.value || old.date,
      produce: Number(iP.value)||0,
      out: Number(iO.value)||0,
      note: iNote.value || ''
    };
    const delta = (newRec.produce - newRec.out) - (old.produce - old.out);
    real.date = newRec.date;
    real.produce = newRec.produce;
    real.out = newRec.out;
    real.note = newRec.note;
    it.qty = (Number(it.qty)||0) + delta;
    sortDetailsByDate(it.details);
    save(); selectItem(it.id);
  }
  function onKey(e){ if(e.key==='Enter'){ e.preventDefault(); commit(); } }
  [iDate,iP,iO,iNote].forEach(el=> el.addEventListener('keydown', onKey));
  saveBtn.addEventListener('click', commit);
  cancelBtn.addEventListener('click', ()=> selectItem(it.id));
}

// Add record
document.getElementById('addRecord').addEventListener('click', ()=>{
  if(!selectedId) return alert('먼저 품목을 선택하세요.');
  const it = items.find(x=>x.id===selectedId); if(!it) return;
  const date=inputDate.value||todayStr(); const produce=Number(produceQty.value)||0; const out=Number(outQty.value)||0; const note=recNote.value||'';
  it.qty = (Number(it.qty)||0) + produce - out; it.details.push({date, produce, out, note}); sortDetailsByDate(it.details); save(); selectItem(it.id);
});

// Item quick add/save/delete
addQuickBtn.addEventListener('click', ()=>{
  const name=prompt('새 품목명 입력:')||''; if(!name) return;
  const qty=Number(prompt('초기수량 입력(숫자):','0')||0);
  const unit=(prompt('단위 입력 (예: kg):','kg')||'kg').trim();
  const obj=normalizeItem({id:uid(), name, qty, unit, details:[]}); items.push(obj); save(); selectItem(obj.id);
});
saveItemBtn.addEventListener('click', ()=>{
  if(!selectedId) return alert('먼저 품목을 선택하세요.');
  const it = items.find(x=>x.id===selectedId); if(!it) return;
  const newName = (editName.value||'').trim() || it.name;
  const newUnit = (editUnit.value||'kg').trim();
  const newQty = Number(editQty.value); if(Number.isNaN(newQty)) return alert('수량은 숫자여야 합니다.');
  it.name = newName; it.unit = newUnit; it.qty = newQty; save(); selectItem(it.id);
});
deleteItemBtn.addEventListener('click', ()=>{
  if(!selectedId) return alert('먼저 품목을 선택하세요.'); const it=items.find(x=>x.id===selectedId); if(!it) return;
  if(!confirm(`[${it.name}] 품목을 삭제하시겠습니까? 이 동작은 되돌릴 수 없습니다.`)) return;
  items = items.filter(x=>x.id!==selectedId); selectedId=null; save(); accordionList.innerHTML=''; editName.value=''; editUnit.value='kg'; editQty.value=0;
});

// Import XLSX/XML (동작은 v8.1.6과 동일)
function sheetToAoA(ws){ return XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''}); }
function parseSplit(table){
  if(!table || table.length===0) return [];
  let name=null;
  for(let c=0;c<(table[0]||[]).length;c++){ const h=(table[0][c]||'').toString(); if(h.includes('품목명')){ name=(h.split(':')[1]||'').trim()||'무명품목'; break; } }
  let baseYear=null; const h0=((table[0]||[])[0]||'').toString().trim(); if(/^\d{4}$/.test(h0)) baseYear=Number(h0);
  let labelRow=0; for(let r=0;r<Math.min(6,table.length);r++){ const row=table[r].map(x=>(x||'').toString().trim()); if(row.includes('생산')&&row.includes('출고')&&row.includes('재고')){ labelRow=r; break; } }
  const lab=(table[labelRow]||[]).map(x=>(x||'').toString().trim()); let iP=-1,iO=-1,iS=-1;
  for(let i=lab.length-1;i>=0;i--){ if(lab[i]==='생산'&&iP<0)iP=i; if(lab[i]==='출고'&&iO<0)iO=i; if(lab[i]==='재고'&&iS<0)iS=i; }
  const dateCol=0; let init=null, start=labelRow+1;
  for(let r=labelRow+1;r<labelRow+4&&r<table.length;r++){ const d=(table[r][dateCol]||'').toString().trim(); const s=Number(String(table[r][iS]||'').replace(/,/g,''))||0; if(!d&&s!==0){ init=s; start=r+1; break; } }
  function normDate(s){ s=(s||'').toString().trim().replace(/\./g,'-').replace(/\//g,'-'); if(/^합계/.test(s)) return ''; const m=s.match(/^(\d{1,2})-(\d{1,2})$/); if(m&&baseYear) return `${baseYear}-${String(m[1]).padStart(2,'0')}-${String(m[2]).padStart(2,'0')}`; return s; }
  const details=[]; let last=init;
  for(let r=start;r<table.length;r++){ const row=table[r]||[]; const first=(row[dateCol]||'').toString().trim(); if(first.startsWith('합계')) break;
    const date=normDate(first); const p=Number(String(row[iP]||'').replace(/,/g,''))||0; const o=Number(String(row[iO]||'').replace(/,/g,''))||0; const s=Number(String(row[iS]||'').replace(/,/g,''))||0;
    if(!date && p===0 && o===0) continue; if(p||o) details.push({date, produce:p, out:o, note:''}); if(s) last=s; }
  const qty=(last!=null)?last:details.reduce((a,d)=>a+(d.produce||0)-(d.out||0),0);
  return [{id:uid(), name:name||'무명품목', qty, unit:'kg', details}];
}
function parseWorkbook(wb){ const out=[]; wb.SheetNames.forEach(n=>{ out.push(...parseSplit(sheetToAoA(wb.Sheets[n]))); }); return out; }

document.getElementById('fileXlsx').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  if(typeof XLSX==='undefined'){ setStatus('XLSX 파서를 불러오지 못했습니다. XML(2003) 형식으로 저장해 불러와 주세요.'); cdnFailBanner.style.display='block'; return; }
  spinner.style.display='inline';
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const wb = XLSX.read(ev.target.result, {type:'array'});
      const newItems = parseWorkbook(wb);
      if(!newItems.length) throw new Error('시트 구조를 인식하지 못했습니다.');
      mergeItems(newItems);
      save(); e.target.value=''; clearStatus(); if(items.length>0) selectItem(items[0].id); alert('XLSX 불러오기가 완료되었습니다.');
    }catch(err){ setStatus('XLSX 파싱 실패: '+err.message); console.error(err); }
    finally{ spinner.style.display='none'; }
  };
  reader.readAsArrayBuffer(f);
});

// XML 2003 불러오기
function parseExcelXml(text){
  const doc = new DOMParser().parseFromString(text, "text/xml");
  const byLocal = (root, name)=>{ const arr=[]; const all=root.getElementsByTagName('*'); for(let i=0;i<all.length;i++){ const n=all[i]; const ln=(n.localName||n.nodeName||'').split(':').pop(); if(ln && ln.toLowerCase()===name.toLowerCase()) arr.push(n);} return arr; };
  const rows = byLocal(doc,'Row'); if(rows.length===0) throw new Error('XML에서 Row를 찾지 못했습니다.');
  const table = rows.map(r => { const cells=byLocal(r,'Cell'); const vals=[]; let col=0; for(const c of cells){ const idx=c.getAttribute('ss:Index')||c.getAttribute('Index'); if(idx){ const t=parseInt(idx,10)-1; while(col<t){ vals.push(''); col++; } } const data=byLocal(c,'Data')[0]; vals.push(data? (data.textContent||'') : ''); col++; } return vals; });
  const nameRow = table[0]||[]; const labelRow = table[1]||[]; let startRow=2; if(/^\d{4}$/.test((nameRow[0]||'').trim())) startRow=3;
  const itemsMeta=[]; let cur=null;
  for(let c=1;c<nameRow.length;c++){ const h=(nameRow[c]||'').trim(); const lab=(labelRow[c]||'').trim(); if(h){ cur={name:h, 생산:null, 출고:null, 재고:null}; itemsMeta.push(cur);} if(cur && ['생산','출고','재고'].includes(lab)) cur[lab]=c; }
  const out=[];
  for(const meta of itemsMeta){ const det=[]; let last=null;
    for(let r=startRow;r<table.length;r++){ const row=table[r]; const first=(row[0]||'').trim(); if(first.startsWith('합계')) break;
      const date=first.replace(/\./g,'-').replace(/\//g,'-'); const p=toNum(row[meta.생산]); const o=toNum(row[meta.출고]); const s=toNum(row[meta.재고]);
      if(p===0 && o===0 && !date) continue; if(p||o) det.push({date, produce:p, out:o, note:''}); if(s) last=s; }
    const qty=(last!=null)?last:det.reduce((a,d)=>a+(d.produce||0)-(d.out||0),0); out.push({id:uid(), name:meta.name, qty, unit:'kg', details:det}); }
  return out;
}
document.getElementById('fileXml').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  spinner.style.display='inline';
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const newItems = parseExcelXml(ev.target.result);
      if(!newItems.length) throw new Error('XML 구조를 인식하지 못했습니다.');
      mergeItems(newItems);
      save(); e.target.value=''; clearStatus(); if(items.length>0) selectItem(items[0].id); alert('XML 불러오기가 완료되었습니다.');
    }catch(err){ setStatus('XML 파싱 실패: '+err.message); console.error(err); }
    finally{ spinner.style.display='none'; }
  };
  reader.readAsText(f, 'utf-8');
});

// 공통 병합
function mergeItems(newItems){
  if(!confirm(`${newItems.length}개 항목을 가져옵니다. 기존 항목에 추가할까요? 확인=추가, 취소=덮어쓰기`)){
    items = newItems;
  } else {
    newItems.forEach(n=>{
      const ex = items.find(x=>x.name===n.name);
      if(ex){
        ex.qty = Number(n.qty)||Number(ex.qty)||0; ex.unit = ex.unit || n.unit;
        const key=r=> (r.date||'')+'|'+(Number(r.produce)||0)+'|'+(Number(r.out)||0)+'|'+(r.note||'');
        const seen=new Set((ex.details||[]).map(key));
        (n.details||[]).forEach(r=>{ const k=key(r); if(!seen.has(k)){ ex.details.push(r); seen.add(k);} });
        ex.details.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
      } else items.push(n);
    });
  }
}

// 내보내기: XLSX -> XML -> CSV
function buildSheets(){
  const inv = [['품목','수량','단위']];
  items.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(it=> inv.push([it.name, Number(it.qty)||0, it.unit||'kg']));
  const det = [['품목','날짜','생산','출고','비고']];
  items.forEach(it=> (it.details||[]).forEach(d=> det.push([it.name, d.date||'', Number(d.produce)||0, Number(d.out)||0, d.note||''])));
  return {inv, det};
}
function downloadBlob(content, filename, type){
  const blob = new Blob([content], {type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
function toCsv(arr){
  return arr.map(row => row.map(cell => {
    const s = String(cell==null?'':cell).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  }).join(',')).join('\n');
}
function toExcelXml(inv, det){
  function sheetXml(name, data){
    const rows = data.map(r => `<Row>` + r.map(c => `<Cell><Data ss:Type="String">${String(c).replace(/&/g,'&amp;').replace(/</g,'&lt;')}</Data></Cell>`).join('') + `</Row>`).join('');
    return `<Worksheet ss:Name="${name}"><Table>${rows}</Table></Worksheet>`;
  }
  const xml = `<?xml version="1.0"?>
  <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
            xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
    ${sheetXml('Inventory', inv)}
    ${sheetXml('Details', det)}
  </Workbook>`;
  return xml;
}

document.getElementById('exportXlsx').addEventListener('click', ()=>{
  const {inv, det} = buildSheets();
  try{
    if(typeof XLSX !== 'undefined'){
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(inv), 'Inventory');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(det), 'Details');
      XLSX.writeFile(wb, 'kimchi_inventory.xlsx');
      return;
    }
    throw new Error('XLSX unavailable');
  }catch(e){
    const xml = toExcelXml(inv, det);
    downloadBlob(xml, 'kimchi_inventory.xml', 'application/vnd.ms-excel');
    setStatus('XLSX 대신 XML(2003) 형식으로 내보냈습니다. 엑셀에서 바로 열 수 있어요.');
  }
});
document.getElementById('exportCsv').addEventListener('click', ()=>{
  const {inv, det} = buildSheets();
  downloadBlob(toCsv(inv), 'Inventory.csv', 'text/csv;charset=utf-8');
  downloadBlob(toCsv(det), 'Details.csv', 'text/csv;charset=utf-8');
  setStatus('CSV 두 개(Inventory/Details)로 내보냈습니다.');
});

// Init
load(); renderList(); if(items.length>0) selectItem(items[0].id);
window.addEventListener('load', ()=>{
  const ok = typeof XLSX!=='undefined'; document.getElementById('xlsState').textContent = ok? '정상': '실패(CDN 차단?)';
  if(!ok){ cdnFailBanner.style.display='block'; }
});
</script>
</body>
</html>
